{% extends "base.html" %}
{% load static %}

{% block title %}La Scarpetta - Ristorante Firenze{% endblock %}

{% block css_files %}
<meta name="description" content="La Scarpetta - Ristorante tradizionale toscano nel cuore di Firenze. Cucina autentica, bistecca fiorentina e atmosfera unica.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="{% static 'pages/Homepage.css' %}">
<link rel="icon" href="{% static 'pages/images/logo_la_scarpetta.ico' %}" type="image/x-icon">
{% endblock %}

{% block content %}
<!-- ═══════════════════════════════════════════
     FLOATING HEADER
     ═══════════════════════════════════════════ -->
<header class="site-header" id="navbar">
    <a href="#hero" class="header-logo">
        <img src="{% static 'pages/images/Logosvgcentrato(1).webp' %}" alt="La Scarpetta">
    </a>

    <div class="header-actions">
        <a href="{% url 'gestionale:prenota_tavolo' %}" class="header-cta lang lang-it">Prenota</a>
        <a href="{% url 'gestionale:prenota_tavolo' %}" class="header-cta lang lang-en" style="display: none;">Book</a>

        <div class="menu-icon" id="menu-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</header>

<!-- ═══════════════════════════════════════════
     OFF-CANVAS NAVIGATION
     ═══════════════════════════════════════════ -->
<nav class="off-canvas" id="mobile-menu">
    <div class="off-canvas-inner">
        <div class="off-canvas-links">
            <a href="#about" class="lang lang-it">Chi Siamo</a>
            <a href="#about" class="lang lang-en" style="display: none;">About</a>

            <a href="#menu" class="lang lang-it">Il Menu</a>
            <a href="#menu" class="lang lang-en" style="display: none;">Menu</a>

            <a href="#gallery" class="lang lang-it">Galleria</a>
            <a href="#gallery" class="lang lang-en" style="display: none;">Gallery</a>

            <a href="#contatti" class="lang lang-it">Contatti</a>
            <a href="#contatti" class="lang lang-en" style="display: none;">Contact</a>

            <a href="{% url 'gestionale:prenota_tavolo' %}" class="off-canvas-cta lang lang-it">Prenota Ora</a>
            <a href="{% url 'gestionale:prenota_tavolo' %}" class="off-canvas-cta lang lang-en" style="display: none;">Book Now</a>
        </div>

        <div class="off-canvas-bottom">
            <a href="tel:0555121510" class="off-canvas-phone">
                <i class="fas fa-phone-alt"></i>
                <span>055 512 1510</span>
            </a>

            <div class="language-switcher-mobile">
                <button onclick="setLanguage('it')" class="lang-button-mobile">
                    <img src="{% static 'pages/images/bandieraitaliana.png' %}" alt="IT" class="flag-icon">
                </button>
                <button onclick="setLanguage('en')" class="lang-button-mobile">
                    <img src="{% static 'pages/images/usa-flag.png' %}" alt="EN" class="flag-icon">
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- Cookie Consent -->
<div id="cookie-consent-modal" style="display:none;">
    <p class="lang lang-it">Utilizziamo i cookie per migliorare la tua esperienza. Continuando accetti la nostra policy.</p>
    <p class="lang lang-en" style="display: none;">We use cookies to enhance your experience. By continuing you accept our policy.</p>
    <button onclick="acceptCookies()" class="lang lang-it">Accetta</button>
    <button onclick="declineCookies()" class="lang lang-it">Rifiuta</button>
    <button onclick="acceptCookies()" class="lang lang-en" style="display: none;">Accept</button>
    <button onclick="declineCookies()" class="lang lang-en" style="display: none;">Decline</button>
</div>

<!-- ═══════════════════════════════════════════
     HERO — FULL VIEWPORT
     ═══════════════════════════════════════════ -->
<section class="hero-banner" id="hero">
    <div class="slider-container">
        <div class="slider-image">
            <img src="{% static 'pages/images/Sala-2.webp' %}" alt="La Scarpetta Firenze">
        </div>
    </div>
    <div class="overlay">
        <div class="logo-container">
            <img src="{% static 'pages/images/LaScarpettaSVG_01_RevA (2) 2.webp' %}" alt="La Scarpetta" id="custom-logo">
        </div>
        <p class="hero-tagline lang lang-it">Tradizione Toscana dal Cuore di Firenze</p>
        <p class="hero-tagline lang lang-en" style="display: none;">Tuscan Tradition from the Heart of Florence</p>
        <div class="hero-scroll-cue">
            <span class="lang lang-it">Scopri</span>
            <span class="lang lang-en" style="display: none;">Discover</span>
            <div class="scroll-line"></div>
        </div>
    </div>
</section>

<!-- ═══════════════════════════════════════════
     ABOUT — EDITORIAL LAYOUT
     Full-width image + overlapping text block
     ═══════════════════════════════════════════ -->
<section class="about-editorial" id="about">
    <div class="about-text-block animate-section">
        <span class="about-label lang lang-it">La Nostra Storia</span>
        <span class="about-label lang lang-en" style="display: none;">Our Story</span>

        <h2 class="about-title">La Scarpetta</h2>

        <p class="lang lang-it">
            Nel cuore di Firenze, celebriamo la tradizione culinaria toscana con passione autentica.
            Il nostro chef crea esperienze di gusto indimenticabili: dall'antipasto sfizioso alla
            bistecca alla fiorentina, fino ai dolci fatti in casa.
        </p>
        <p class="lang lang-en" style="display: none;">
            In the heart of Florence, we celebrate Tuscan culinary tradition with authentic passion.
            Our chef creates unforgettable taste experiences: from delicious appetizers to Florentine
            steak, to homemade desserts.
        </p>

        <p class="lang lang-it">
            Un'atmosfera calda e accogliente dove ogni ospite diventa parte della nostra famiglia.
            <a href="https://www.google.com/maps/place/La+Scarpetta/@43.7742329,11.2115738,17z" target="_blank" class="about-link">Vieni a trovarci <i class="fas fa-arrow-right"></i></a>
        </p>
        <p class="lang lang-en" style="display: none;">
            A warm and welcoming atmosphere where every guest becomes part of our family.
            <a href="https://www.google.com/maps/place/La+Scarpetta/@43.7742329,11.2115738,17z" target="_blank" class="about-link">Come visit us <i class="fas fa-arrow-right"></i></a>
        </p>
    </div>
</section>

<!-- ═══════════════════════════════════════════
     MENU / PDF — EDITORIAL
     ═══════════════════════════════════════════ -->
<section class="menu-editorial" id="menu">
    <div class="menu-editorial-header">
        <span class="gold-rule"></span>
        <h2 class="menu-editorial-title lang lang-it">Il Nostro Menu</h2>
        <h2 class="menu-editorial-title lang lang-en" style="display: none;">Our Menu</h2>
        <span class="gold-rule"></span>
    </div>

    {% if latest_pdf %}
    <div class="pdf-container">
        <div class="pdf-carousel-container" id="MenuPDF">
            <div class="pdf-carousel-wrapper" id="pdf-carousel-wrapper">
                <canvas id="the-canvas"></canvas>
                <div id="loading-indicator" class="loading lang lang-it">Caricamento...</div>
                <div id="loading-indicator" class="loading lang lang-en" style="display: none;">Loading...</div>
            </div>
        </div>
        <div class="pdf-controls">
            <button id="prev" class="btn btn-secondary">&#10094;</button>
            <div class="carousel-indicators" id="pdf-indicators"></div>
            <button id="next" class="btn btn-secondary">&#10095;</button>
            <button id="zoom-in" class="btn btn-secondary">+</button>
            <button id="zoom-out" class="btn btn-secondary">-</button>
        </div>
    </div>
    {% endif %}

    {% if user.is_staff %}
    <div class="menu-upload-form lang lang-it">
        <h3>Carica Nuovo Menu</h3>
        <form method="post" enctype="multipart/form-data" action="{% url 'menu_upload' %}">
            {% csrf_token %}
            <label for="id_file">Seleziona PDF</label>
            <input id="id_file" type="file" name="file" onchange="document.getElementById('file-name').innerHTML = this.files[0].name">
            <span id="file-name"></span>
            <button type="submit">Carica</button>
        </form>
    </div>
    <div class="menu-upload-form lang lang-en" style="display: none;">
        <h3>Upload New Menu</h3>
        <form method="post" enctype="multipart/form-data" action="{% url 'menu_upload' %}">
            {% csrf_token %}
            <label for="id_file_en">Select PDF</label>
            <input id="id_file_en" type="file" name="file" onchange="document.getElementById('file-name-en').innerHTML = this.files[0].name">
            <span id="file-name-en"></span>
            <button type="submit">Upload</button>
        </form>
    </div>
    {% endif %}
</section>

<!-- ═══════════════════════════════════════════
     GALLERY — FULL-BLEED CAROUSEL
     ═══════════════════════════════════════════ -->
<section class="gallery-fullbleed" id="gallery">
    <div class="carousel-container animate-section">
        <div class="slides-wrapper">
            <div class="carousel-image">
                <img src="{% static 'pages/images/Foto-29.jpg' %}" alt="La Scarpetta Piatti">
            </div>
            <div class="carousel-image">
                <img src="{% static 'pages/images/Foto-7.jpg' %}" alt="La Scarpetta Cucina">
            </div>
            <div class="carousel-image">
                <img src="{% static 'pages/images/Foto-13.jpg' %}" alt="La Scarpetta Atmosfera">
            </div>
        </div>

        <a class="previous" onclick="prevSlide()">&#10094;</a>
        <a class="next" onclick="nextSlide()">&#10095;</a>

        <div class="carousel-indicators">
            <span class="carousel-dot active" data-index="0"></span>
            <span class="carousel-dot" data-index="1"></span>
            <span class="carousel-dot" data-index="2"></span>
        </div>
    </div>
</section>

<!-- ═══════════════════════════════════════════
     CONTATTI — UNIFIED MINIMAL
     ═══════════════════════════════════════════ -->
<section class="contact-minimal" id="contatti">
    <div class="contact-inner">
        <span class="contact-label lang lang-it">Trovateci</span>
        <span class="contact-label lang lang-en" style="display: none;">Find Us</span>

        <h2 class="contact-title lang lang-it">Contatti</h2>
        <h2 class="contact-title lang lang-en" style="display: none;">Contact</h2>

        <div class="contact-details">
            <a href="https://www.google.com/maps/place/La+Scarpetta" target="_blank" class="contact-line">
                <i class="fas fa-map-marker-alt"></i>
                <span>Via del Ponte Sospeso, 7r — Firenze</span>
            </a>
            <a href="tel:0555121510" class="contact-line">
                <i class="fas fa-phone-alt"></i>
                <span>055 512 1510</span>
            </a>
            <a href="mailto:lascarpettafirenze@gmail.com" class="contact-line">
                <i class="fas fa-envelope"></i>
                <span>lascarpettafirenze@gmail.com</span>
            </a>
        </div>

        <div class="contact-social">
            <a href="https://instagram.com/lascarpettafirenze" target="_blank" aria-label="Instagram">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://facebook.com/lascarpettafirenze" target="_blank" aria-label="Facebook">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href="https://wa.me/3755374459" target="_blank" aria-label="WhatsApp">
                <i class="fab fa-whatsapp"></i>
            </a>
        </div>

        <div class="contact-hours">
            <div class="hours-line">
                <span class="lang lang-it">Pranzo</span>
                <span class="lang lang-en" style="display: none;">Lunch</span>
                <span class="hours-dash"></span>
                <span>12:00 — 15:00</span>
            </div>
            <div class="hours-line">
                <span class="lang lang-it">Cena</span>
                <span class="lang lang-en" style="display: none;">Dinner</span>
                <span class="hours-dash"></span>
                <span>19:00 — 00:00</span>
            </div>
            <p class="hours-note">
                <span class="lang lang-it">Aperti tutti i giorni</span>
                <span class="lang lang-en" style="display: none;">Open every day</span>
            </p>
        </div>
    </div>

    <div class="map-fullbleed" id="map">
        <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2881.5!2d11.2115738!3d43.7742329!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x132a5aa11009a4f9%3A0x7b2045d5b4037df9!2sVia%20del%20Ponte%20Sospeso%2C%2050142%20Firenze%20FI!5e0!3m2!1sit!2sit!4v1647101325581!5m2!1sit!2sit"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>
    </div>
</section>

<!-- ═══════════════════════════════════════════
     FOOTER — UNIFIED
     ═══════════════════════════════════════════ -->
<footer class="footer-minimal">
    <div class="footer-inner">
        <p class="footer-copy">&copy; 2026 La Scarpetta</p>
        <div class="footer-links">
            <a href="{% url 'cookie_consent:privacy_policy' %}">Privacy Policy</a>
            <a href="{% url 'cookie_consent:cookie_policy' %}">Cookie Policy</a>
            {% if user.is_authenticated %}
            <a href="{% url 'logout' %}" class="admin-link">Logout</a>
            {% endif %}
        </div>
        <p class="footer-credit">Engineered by Tempora Innovation</p>
    </div>
</footer>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

<script>
// Language Switching
function setLanguage(lang) {
    document.querySelectorAll('.lang').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.lang-' + lang).forEach(el => el.style.display = '');
    localStorage.setItem('preferredLanguage', lang);

    document.querySelectorAll('.top-bar-lang-btn, .lang-button-mobile').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('onclick')?.includes("'" + lang + "'"));
    });

    document.body.classList.add('page-flash');
    setTimeout(() => document.body.classList.remove('page-flash'), 300);
}

function loadPreferredLanguage() {
    setLanguage(localStorage.getItem('preferredLanguage') || 'it');
}

document.addEventListener('DOMContentLoaded', loadPreferredLanguage);
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Navbar scroll effect
    const navbar = document.getElementById('navbar');
    let lastScroll = 0;

    window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        navbar.classList.toggle('scrolled', currentScroll > 50);
        lastScroll = currentScroll;
    });

    // Mobile menu toggle
    const menuIcon = document.getElementById('menu-icon');
    const mobileMenu = document.getElementById('mobile-menu');

    menuIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        menuIcon.classList.toggle('active');
        mobileMenu.classList.toggle('active');
        document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
    });

    document.addEventListener('click', (e) => {
        if (!menuIcon.contains(e.target) && !mobileMenu.contains(e.target)) {
            menuIcon.classList.remove('active');
            mobileMenu.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            menuIcon.classList.remove('active');
            mobileMenu.classList.remove('active');
            document.body.style.overflow = '';
        });
    });

    // Chiudi menu mobile con scroll (touch)
    let touchStartY = 0;
    let touchMoved = false;

    document.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
        touchMoved = false;
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
        if (!mobileMenu.classList.contains('active')) return;

        const touchY = e.touches[0].clientY;
        const diff = Math.abs(touchY - touchStartY);

        // Se l'utente scorre più di 30px, chiudi il menu
        if (diff > 30 && !touchMoved) {
            touchMoved = true;
            menuIcon.classList.remove('active');
            mobileMenu.classList.remove('active');
            document.body.style.overflow = '';
        }
    }, { passive: true });

    // Image Carousel
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-image');
    const dots = document.querySelectorAll('.carousel-dot');
    const wrapper = document.querySelector('.slides-wrapper');

    function showSlide(index) {
        if (index >= slides.length) currentSlide = 0;
        if (index < 0) currentSlide = slides.length - 1;
        wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        dots.forEach((dot, i) => dot.classList.toggle('active', i === currentSlide));
    }

    window.prevSlide = () => { currentSlide--; showSlide(currentSlide); };
    window.nextSlide = () => { currentSlide++; showSlide(currentSlide); };

    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => { currentSlide = index; showSlide(currentSlide); });
    });

    // Auto-advance carousel
    setInterval(() => { currentSlide++; showSlide(currentSlide); }, 5000);

    // Scroll animations
    const animateSections = document.querySelectorAll('.animate-section');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                entry.target.classList.add(index % 2 === 0 ? 'fade-in-left' : 'fade-in-right');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    animateSections.forEach(section => observer.observe(section));

    // PDF Viewer
    {% if latest_pdf %}
    const url = "{{ latest_pdf.file.url }}";
    let pdfDoc = null, pageNum = 1, scale = 1.5;
    const canvas = document.getElementById('the-canvas');
    const ctx = canvas.getContext('2d');

    pdfjsLib.getDocument(url).promise.then(pdf => {
        pdfDoc = pdf;
        createPdfIndicators();
        renderPage(pageNum);
    });

    function renderPage(num) {
        pdfDoc.getPage(num).then(page => {
            const viewport = page.getViewport({ scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            page.render({ canvasContext: ctx, viewport });
            updatePdfIndicators(num);
        });
    }

    function createPdfIndicators() {
        const container = document.getElementById('pdf-indicators');
        container.innerHTML = '';
        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const dot = document.createElement('span');
            dot.className = 'carousel-dot';
            dot.dataset.pageNumber = i;
            dot.addEventListener('click', () => { pageNum = i; renderPage(i); });
            container.appendChild(dot);
        }
        updatePdfIndicators(1);
    }

    function updatePdfIndicators(num) {
        document.querySelectorAll('#pdf-indicators .carousel-dot').forEach((dot, i) => {
            dot.classList.toggle('active', i + 1 === num);
        });
    }

    document.getElementById('prev')?.addEventListener('click', () => {
        if (pageNum > 1) { pageNum--; renderPage(pageNum); }
    });

    document.getElementById('next')?.addEventListener('click', () => {
        if (pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); }
    });

    document.getElementById('zoom-in')?.addEventListener('click', () => { scale += 0.25; renderPage(pageNum); });
    document.getElementById('zoom-out')?.addEventListener('click', () => { if (scale > 0.5) { scale -= 0.25; renderPage(pageNum); } });

    // Swipe support for PDF
    const pdfWrapper = document.getElementById('pdf-carousel-wrapper');
    if (pdfWrapper && typeof Hammer !== 'undefined') {
        const hammer = new Hammer(pdfWrapper);
        hammer.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL });
        hammer.on('swipeleft', () => { if (pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); } });
        hammer.on('swiperight', () => { if (pageNum > 1) { pageNum--; renderPage(pageNum); } });
    }
    {% endif %}
});
</script>

<script>
// Cookie Consent
function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
}

function acceptCookies() {
    document.cookie = "cookie_consent=true; max-age=" + (60*60*24*365) + "; path=/";
    document.getElementById('cookie-consent-modal').style.display = 'none';
    document.getElementById('map').style.display = 'block';
}

function declineCookies() {
    document.cookie = "cookie_consent=false; max-age=" + (60*60*24*365) + "; path=/";
    document.getElementById('cookie-consent-modal').style.display = 'none';
    document.getElementById('map').style.display = 'none';
}

window.onload = function() {
    const consent = getCookie('cookie_consent');
    document.getElementById('cookie-consent-modal').style.display = consent === 'true' ? 'none' : 'flex';
    const map = document.getElementById('map');
    if (map) map.style.display = consent === 'true' ? 'block' : 'none';
};
</script>
{% endblock %}
