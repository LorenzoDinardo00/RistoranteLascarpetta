{% extends "base.html" %}
{% load static %}

{% block title %}La Scarpetta - Ristorante Firenze{% endblock %}

{% block css_files %}
<meta name="description" content="La Scarpetta - Ristorante tradizionale toscano nel cuore di Firenze. Cucina autentica, bistecca fiorentina e atmosfera unica.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&family=Inter:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Engagement&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="{% static 'pages/Homepage.css' %}">
<link rel="icon" href="{% static 'pages/images/logo_la_scarpetta.ico' %}" type="image/x-icon">
{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="top-bar">
    <div class="top-bar-content">
        <a href="tel:0555121510" class="top-bar-phone">
            <i class="fas fa-phone-alt"></i>
            <span>055 512 1510</span>
        </a>
        <div class="top-bar-separator"></div>
        <div class="top-bar-languages">
            <button onclick="setLanguage('it')" class="top-bar-lang-btn active" title="Italiano">
                <img src="{% static 'pages/images/bandieraitaliana.png' %}" alt="IT" class="flag-icon">
            </button>
            <button onclick="setLanguage('en')" class="top-bar-lang-btn" title="English">
                <img src="{% static 'pages/images/usa-flag.png' %}" alt="EN" class="flag-icon">
            </button>
        </div>
    </div>
</div>

<!-- Navigation -->
<nav class="navbar" id="navbar">
    <div class="menu left">
        <a href="#about" class="lang lang-it">Chi Siamo</a>
        <a href="#menu" class="lang lang-it">Il Menu</a>
        <a href="#about" class="lang lang-en" style="display: none;">About</a>
        <a href="#menu" class="lang lang-en" style="display: none;">Menu</a>
    </div>

    <div class="logo">
        <a href="#hero">
            <img src="{% static 'pages/images/Logosvgcentrato(1).webp' %}" alt="La Scarpetta">
        </a>
    </div>

    <div class="menu right">
        <a href="#contatti" class="lang lang-it">Contatti</a>
        <a href="{% url 'gestionale:prenota_tavolo' %}" id="booking-button" class="lang lang-it">Prenota</a>
        <a href="#contatti" class="lang lang-en" style="display: none;">Contact</a>
        <a href="{% url 'gestionale:prenota_tavolo' %}" id="booking-button" class="lang lang-en" style="display: none;">Book</a>
    </div>

    <div class="menu-icon" id="menu-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</nav>

<!-- Mobile Menu -->
<div class="mobile-menu" id="mobile-menu">
    <a href="#about" class="lang lang-it">Chi Siamo</a>
    <a href="#menu" class="lang lang-it">Il Menu</a>
    <a href="#contattiMobile" class="lang lang-it">Contatti</a>
    <a href="{% url 'gestionale:prenota_tavolo' %}" id="booking-button-mobile" class="lang lang-it">Prenota Ora</a>

    <a href="#about" class="lang lang-en" style="display: none;">About</a>
    <a href="#menu" class="lang lang-en" style="display: none;">Menu</a>
    <a href="#contattiMobile" class="lang lang-en" style="display: none;">Contact</a>
    <a href="{% url 'gestionale:prenota_tavolo' %}" id="booking-button-mobile" class="lang lang-en" style="display: none;">Book Now</a>

    <div class="language-switcher-mobile">
        <button onclick="setLanguage('it')" class="lang-button-mobile">
            <img src="{% static 'pages/images/bandieraitaliana.png' %}" alt="IT" class="flag-icon">
        </button>
        <button onclick="setLanguage('en')" class="lang-button-mobile">
            <img src="{% static 'pages/images/usa-flag.png' %}" alt="EN" class="flag-icon">
        </button>
    </div>
</div>

<!-- Cookie Consent -->
<div id="cookie-consent-modal" style="display:none;">
    <p class="lang lang-it">Utilizziamo i cookie per migliorare la tua esperienza. Continuando accetti la nostra policy.</p>
    <p class="lang lang-en" style="display: none;">We use cookies to enhance your experience. By continuing you accept our policy.</p>
    <button onclick="acceptCookies()" class="lang lang-it">Accetta</button>
    <button onclick="declineCookies()" class="lang lang-it">Rifiuta</button>
    <button onclick="acceptCookies()" class="lang lang-en" style="display: none;">Accept</button>
    <button onclick="declineCookies()" class="lang lang-en" style="display: none;">Decline</button>
</div>

<!-- Hero Section -->
<section class="hero-banner" id="hero">
    <div class="slider-container">
        <div class="slider-image">
            <img src="{% static 'pages/images/Sala-2.webp' %}" alt="La Scarpetta Firenze">
        </div>
    </div>
    <div class="overlay">
        <div class="logo-container">
            <img src="{% static 'pages/images/LaScarpettaSVG_01_RevA (2) 2.webp' %}" alt="La Scarpetta" id="custom-logo">
        </div>
    </div>
</section>

<!-- About Section -->
<section class="container1" id="about">
    <div class="text-container animate-section">
        <span class="intro lang lang-it">La Nostra Storia</span>
        <span class="intro lang lang-en" style="display: none;">Our Story</span>

        <h1 id="scritta" class="lang lang-it">La Scarpetta</h1>
        <h1 class="lang lang-en" style="display: none;">La Scarpetta</h1>

        <p class="lang lang-it">
            Nel cuore di Firenze, celebriamo la tradizione culinaria toscana con passione autentica.
            Il nostro chef crea esperienze di gusto indimenticabili: dall'antipasto sfizioso alla
            bistecca alla fiorentina, fino ai dolci fatti in casa.
        </p>
        <p class="lang lang-en" style="display: none;">
            In the heart of Florence, we celebrate Tuscan culinary tradition with authentic passion.
            Our chef creates unforgettable taste experiences: from delicious appetizers to Florentine
            steak, to homemade desserts.
        </p>

        <p class="lang lang-it">
            Un'atmosfera calda e accogliente dove ogni ospite diventa parte della nostra famiglia.
            <a href="https://www.google.com/maps/place/La+Scarpetta/@43.7742329,11.2115738,17z" target="_blank">Vieni a trovarci</a>
        </p>
        <p class="lang lang-en" style="display: none;">
            A warm and welcoming atmosphere where every guest becomes part of our family.
            <a href="https://www.google.com/maps/place/La+Scarpetta/@43.7742329,11.2115738,17z" target="_blank">Come visit us</a>
        </p>
    </div>

    <div class="image-container1 animate-section">
        <img src="{% static 'pages/images/Osteria.webp' %}" alt="La Scarpetta Ristorante Firenze">
    </div>
</section>

<!-- Menu Section -->
<section class="gourmet-section" id="menu">
    <h1 class="gourmet-title lang lang-it">Il nostro Menu</h1>
    <h1 class="gourmet-title lang lang-en" style="display: none;">Our Menu</h1>

    {% if latest_pdf %}
    <div class="pdf-container">
        <div class="pdf-carousel-container" id="MenuPDF">
            <div class="pdf-carousel-wrapper" id="pdf-carousel-wrapper">
                <canvas id="the-canvas"></canvas>
                <div id="loading-indicator" class="loading lang lang-it">Caricamento...</div>
                <div id="loading-indicator" class="loading lang lang-en" style="display: none;">Loading...</div>
            </div>
        </div>
        <div class="pdf-controls">
            <button id="prev" class="btn btn-secondary">&#10094;</button>
            <div class="carousel-indicators" id="pdf-indicators"></div>
            <button id="next" class="btn btn-secondary">&#10095;</button>
            <button id="zoom-in" class="btn btn-secondary">+</button>
            <button id="zoom-out" class="btn btn-secondary">-</button>
        </div>
    </div>
    {% endif %}

    {% if user.is_staff %}
    <div class="menu-upload-form lang lang-it">
        <h3>Carica Nuovo Menu</h3>
        <form method="post" enctype="multipart/form-data" action="{% url 'menu_upload' %}">
            {% csrf_token %}
            <label for="id_file">Seleziona PDF</label>
            <input id="id_file" type="file" name="file" onchange="document.getElementById('file-name').innerHTML = this.files[0].name">
            <span id="file-name"></span>
            <button type="submit">Carica</button>
        </form>
    </div>
    <div class="menu-upload-form lang lang-en" style="display: none;">
        <h3>Upload New Menu</h3>
        <form method="post" enctype="multipart/form-data" action="{% url 'menu_upload' %}">
            {% csrf_token %}
            <label for="id_file_en">Select PDF</label>
            <input id="id_file_en" type="file" name="file" onchange="document.getElementById('file-name-en').innerHTML = this.files[0].name">
            <span id="file-name-en"></span>
            <button type="submit">Upload</button>
        </form>
    </div>
    {% endif %}
</section>

<!-- Gallery Carousel -->
<div class="carousel-container animate-section">
    <div class="slides-wrapper">
        <div class="carousel-image">
            <img src="{% static 'pages/images/Foto-29.jpg' %}" alt="La Scarpetta Piatti">
        </div>
        <div class="carousel-image">
            <img src="{% static 'pages/images/Foto-7.jpg' %}" alt="La Scarpetta Cucina">
        </div>
        <div class="carousel-image">
            <img src="{% static 'pages/images/Foto-13.jpg' %}" alt="La Scarpetta Atmosfera">
        </div>
    </div>
    <a class="previous" onclick="prevSlide()">&#10094;</a>
    <a class="next" onclick="nextSlide()">&#10095;</a>
</div>

<div class="carousel-indicators">
    <span class="carousel-dot active" data-index="0"></span>
    <span class="carousel-dot" data-index="1"></span>
    <span class="carousel-dot" data-index="2"></span>
</div>

<!-- Contact Section Desktop -->
<section class="content-container" id="contatti">
    <div class="contact-hours-container">
        <div class="contact-left">
            <h2 class="lang lang-it">Contatti</h2>
            <h2 class="lang lang-en" style="display: none;">Contact</h2>

            <div class="contact-info animate-section">
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <a href="https://www.google.com/maps/place/La+Scarpetta" target="_blank">
                        <p>Via del Ponte Sospeso, 7r - Firenze</p>
                    </a>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone-alt"></i>
                    <a href="tel:0555121510"><p>055 512 1510</p></a>
                </div>
                <div class="contact-item">
                    <i class="fab fa-instagram"></i>
                    <a href="https://instagram.com/lascarpettafirenze" target="_blank"><p>@lascarpettafirenze</p></a>
                </div>
                <div class="contact-item">
                    <i class="fab fa-facebook"></i>
                    <a href="https://facebook.com/lascarpettafirenze" target="_blank"><p>lascarpettafirenze</p></a>
                </div>
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <a href="mailto:lascarpettafirenze@gmail.com"><p>lascarpettafirenze@gmail.com</p></a>
                </div>
                <div class="contact-item">
                    <i class="fab fa-whatsapp"></i>
                    <a href="https://wa.me/3755374459" target="_blank">
                        <p class="lang lang-it">Scrivici su WhatsApp</p>
                        <p class="lang lang-en" style="display: none;">Message us on WhatsApp</p>
                    </a>
                </div>
            </div>
        </div>

        <div class="hours-right animate-section">
            <h2 class="lang lang-it">Orari</h2>
            <h2 class="lang lang-en" style="display: none;">Hours</h2>

            <div class="opening-hours">
                <p>
                    <strong class="lang lang-it">Pranzo:</strong>
                    <strong class="lang lang-en" style="display: none;">Lunch:</strong>
                    <span>12:00 - 15:00</span>
                </p>
                <p>
                    <strong class="lang lang-it">Cena:</strong>
                    <strong class="lang lang-en" style="display: none;">Dinner:</strong>
                    <span>19:00 - 00:00</span>
                </p>
                <p>
                    <strong class="lang lang-it">Aperti:</strong>
                    <strong class="lang lang-en" style="display: none;">Open:</strong>
                    <span class="lang lang-it">Tutti i giorni</span>
                    <span class="lang lang-en" style="display: none;">Every day</span>
                </p>
            </div>

            <div id="map">
                <iframe
                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2881.5!2d11.2115738!3d43.7742329!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x132a5aa11009a4f9%3A0x7b2045d5b4037df9!2sVia%20del%20Ponte%20Sospeso%2C%2050142%20Firenze%20FI!5e0!3m2!1sit!2sit!4v1647101325581!5m2!1sit!2sit"
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
        </div>
    </div>
</section>

<!-- Contact Section Mobile -->
<section class="mobile-contact-section" id="contattiMobile">
    <div class="mobile-contact-grid">
        <!-- Colonna Contatti -->
        <div class="mobile-contact-card">
            <h2 class="lang lang-it">Contatti</h2>
            <h2 class="lang lang-en" style="display: none;">Contact</h2>

            <div class="contact-item-mobile">
                <i class="fas fa-map-marker-alt"></i>
                <a href="https://www.google.com/maps/place/La+Scarpetta" target="_blank">Via del Ponte Sospeso, 7r<br>Firenze</a>
            </div>
            <div class="contact-item-mobile">
                <i class="fas fa-phone-alt"></i>
                <a href="tel:0555121510">055 512 1510</a>
            </div>
            <div class="contact-item-mobile">
                <i class="fas fa-envelope"></i>
                <a href="mailto:lascarpettafirenze@gmail.com">lascarpettafirenze@gmail.com</a>
            </div>

            <div class="social-links-mobile">
                <a href="https://instagram.com/lascarpettafirenze" target="_blank" class="social-btn">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://facebook.com/lascarpettafirenze" target="_blank" class="social-btn">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://wa.me/3755374459" target="_blank" class="social-btn whatsapp">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </div>
        </div>

        <!-- Colonna Orari -->
        <div class="mobile-hours-card">
            <h2 class="lang lang-it">Orari</h2>
            <h2 class="lang lang-en" style="display: none;">Hours</h2>

            <div class="hours-block">
                <div class="hours-row">
                    <span class="hours-label lang lang-it">Pranzo</span>
                    <span class="hours-label lang lang-en" style="display: none;">Lunch</span>
                    <span class="hours-time">12:00 - 15:00</span>
                </div>
                <div class="hours-row">
                    <span class="hours-label lang lang-it">Cena</span>
                    <span class="hours-label lang lang-en" style="display: none;">Dinner</span>
                    <span class="hours-time">19:00 - 00:00</span>
                </div>
                <div class="hours-note">
                    <span class="lang lang-it">Aperti tutti i giorni</span>
                    <span class="lang lang-en" style="display: none;">Open every day</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Footer Desktop -->
<footer class="footer fpc">
    <p>
        &copy; 2025 La Scarpetta
        <a href="{% url 'cookie_consent:privacy_policy' %}">Privacy Policy</a>
        <a href="{% url 'cookie_consent:cookie_policy' %}">Cookie Policy</a>
        {% if user.is_authenticated %}
        <a href="{% url 'logout' %}" class="admin-link">Logout</a>
        {% endif %}
        Engineered by Tempora Innovation
    </p>
</footer>

<!-- Footer Mobile -->
<footer class="footer fmobile">
    <p>&copy; 2025 La Scarpetta</p>
    <div class="footer-links">
        <a href="{% url 'cookie_consent:privacy_policy' %}">Privacy Policy</a>
        <span class="separator">|</span>
        <a href="{% url 'cookie_consent:cookie_policy' %}">Cookie Policy</a>
        {% if user.is_authenticated %}
        <span class="separator">|</span>
        <a href="{% url 'logout' %}" class="admin-link">Logout</a>
        {% endif %}
    </div>
    <p class="footer-credit">Engineered by Tempora Innovation</p>
</footer>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

<script>
// Language Switching
function setLanguage(lang) {
    document.querySelectorAll('.lang').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.lang-' + lang).forEach(el => el.style.display = '');
    localStorage.setItem('preferredLanguage', lang);

    document.querySelectorAll('.top-bar-lang-btn, .lang-button-mobile').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('onclick')?.includes("'" + lang + "'"));
    });

    document.body.classList.add('page-flash');
    setTimeout(() => document.body.classList.remove('page-flash'), 300);
}

function loadPreferredLanguage() {
    setLanguage(localStorage.getItem('preferredLanguage') || 'it');
}

document.addEventListener('DOMContentLoaded', loadPreferredLanguage);
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Navbar scroll effect
    const navbar = document.getElementById('navbar');
    let lastScroll = 0;

    window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        navbar.classList.toggle('scrolled', currentScroll > 50);
        lastScroll = currentScroll;
    });

    // Mobile menu toggle
    const menuIcon = document.getElementById('menu-icon');
    const mobileMenu = document.getElementById('mobile-menu');

    menuIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        menuIcon.classList.toggle('active');
        mobileMenu.classList.toggle('active');
        document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
    });

    document.addEventListener('click', (e) => {
        if (!menuIcon.contains(e.target) && !mobileMenu.contains(e.target)) {
            menuIcon.classList.remove('active');
            mobileMenu.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            menuIcon.classList.remove('active');
            mobileMenu.classList.remove('active');
            document.body.style.overflow = '';
        });
    });

    // Image Carousel
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-image');
    const dots = document.querySelectorAll('.carousel-dot');
    const wrapper = document.querySelector('.slides-wrapper');

    function showSlide(index) {
        if (index >= slides.length) currentSlide = 0;
        if (index < 0) currentSlide = slides.length - 1;
        wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        dots.forEach((dot, i) => dot.classList.toggle('active', i === currentSlide));
    }

    window.prevSlide = () => { currentSlide--; showSlide(currentSlide); };
    window.nextSlide = () => { currentSlide++; showSlide(currentSlide); };

    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => { currentSlide = index; showSlide(currentSlide); });
    });

    // Auto-advance carousel
    setInterval(() => { currentSlide++; showSlide(currentSlide); }, 5000);

    // Scroll animations
    const animateSections = document.querySelectorAll('.animate-section');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                entry.target.classList.add(index % 2 === 0 ? 'fade-in-left' : 'fade-in-right');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    animateSections.forEach(section => observer.observe(section));

    // PDF Viewer
    {% if latest_pdf %}
    const url = "{{ latest_pdf.file.url }}";
    let pdfDoc = null, pageNum = 1, scale = 1.5;
    const canvas = document.getElementById('the-canvas');
    const ctx = canvas.getContext('2d');

    pdfjsLib.getDocument(url).promise.then(pdf => {
        pdfDoc = pdf;
        createPdfIndicators();
        renderPage(pageNum);
    });

    function renderPage(num) {
        pdfDoc.getPage(num).then(page => {
            const viewport = page.getViewport({ scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            page.render({ canvasContext: ctx, viewport });
            updatePdfIndicators(num);
        });
    }

    function createPdfIndicators() {
        const container = document.getElementById('pdf-indicators');
        container.innerHTML = '';
        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const dot = document.createElement('span');
            dot.className = 'carousel-dot';
            dot.dataset.pageNumber = i;
            dot.addEventListener('click', () => { pageNum = i; renderPage(i); });
            container.appendChild(dot);
        }
        updatePdfIndicators(1);
    }

    function updatePdfIndicators(num) {
        document.querySelectorAll('#pdf-indicators .carousel-dot').forEach((dot, i) => {
            dot.classList.toggle('active', i + 1 === num);
        });
    }

    document.getElementById('prev')?.addEventListener('click', () => {
        if (pageNum > 1) { pageNum--; renderPage(pageNum); }
    });

    document.getElementById('next')?.addEventListener('click', () => {
        if (pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); }
    });

    document.getElementById('zoom-in')?.addEventListener('click', () => { scale += 0.25; renderPage(pageNum); });
    document.getElementById('zoom-out')?.addEventListener('click', () => { if (scale > 0.5) { scale -= 0.25; renderPage(pageNum); } });

    // Swipe support for PDF
    const pdfWrapper = document.getElementById('pdf-carousel-wrapper');
    if (pdfWrapper && typeof Hammer !== 'undefined') {
        const hammer = new Hammer(pdfWrapper);
        hammer.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL });
        hammer.on('swipeleft', () => { if (pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); } });
        hammer.on('swiperight', () => { if (pageNum > 1) { pageNum--; renderPage(pageNum); } });
    }
    {% endif %}
});
</script>

<script>
// Cookie Consent
function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
}

function acceptCookies() {
    document.cookie = "cookie_consent=true; max-age=" + (60*60*24*365) + "; path=/";
    document.getElementById('cookie-consent-modal').style.display = 'none';
    document.getElementById('map').style.display = 'block';
}

function declineCookies() {
    document.cookie = "cookie_consent=false; max-age=" + (60*60*24*365) + "; path=/";
    document.getElementById('cookie-consent-modal').style.display = 'none';
    document.getElementById('map').style.display = 'none';
}

window.onload = function() {
    const consent = getCookie('cookie_consent');
    document.getElementById('cookie-consent-modal').style.display = consent === 'true' ? 'none' : 'flex';
    const map = document.getElementById('map');
    if (map) map.style.display = consent === 'true' ? 'block' : 'none';
};
</script>
{% endblock %}
